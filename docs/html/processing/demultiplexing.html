

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Demultiplexing &mdash; Analysis of Metagenetic data for Macroecology  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Grep command" href="fundamentals/grep_command.html" />
    <link rel="prev" title="FASTQ files" href="fastq.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> Analysis of Metagenetic data for Macroecology
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../notes.html">The Practical Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linuxintro.html">Introduction to the linux command line</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../readprocessing.html">Read processing</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="fastq.html">FASTQ files</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Demultiplexing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="fundamentals/grep_command.html">Grep command</a></li>
<li class="toctree-l3"><a class="reference internal" href="extensions/cutadapt_extension.html">Cutadapt extension</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="primer_removal.html">Primer removal</a></li>
<li class="toctree-l2"><a class="reference internal" href="pair_merging.html">Pair merging</a></li>
<li class="toctree-l2"><a class="reference internal" href="data_concat.html">Data concatenation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../filtering.html">Filtering Amplicon Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../otudelim.html">OTU Delimitation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../otuid.html">Identifying OTUs and Generating Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trees.html">Building Phylogenetic Trees for Metagenetics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../placing_otus_in_trees.html">Placing OTUs in reference trees</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Analysis of Metagenetic data for Macroecology</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../readprocessing.html">Read processing</a> &raquo;</li>
        
      <li>Demultiplexing</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/processing/demultiplexing.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="demultiplexing">
<span id="id1"></span><h1>Demultiplexing<a class="headerlink" href="#demultiplexing" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound">
</div>
<p>There are many ways in which metabarcoding libraries may be sequenced. We are going to work here with a library preparation pipeline that involved indexing amplicons during initial PCR, such that each sample had a different 6-base index within a library. Once sequenced, we need to use these index sequences to separate out different samples. This process is called ​**demultiplexing​.** In this case, the amplicons were sequenced using paired-end sequencing, meaning the two ends of each fragment were read, working inwards. We have eight sequence files received from our sequencing facility, one for each read direction for each of four libraries.</p>
<p>Each of these libraries is actually three different metabarcoding samples. Each sample within each library was amplified with a different 6-base index. You can see these indices in the indices.txt file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cat indices.txt
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">​cat</span></code> command simply outputs the entire contents of the files it is given, one after the other. Here we’re using it to just output the content of one file, but look out for this command later!</p>
<p>When we did PCR, the index was part of the primers used, so that the reaction added this sequence to our amplicons when copying them. The primers used for this metabarcoding reaction were:</p>
<p>Forward (R1): <strong>​CCNGAYATRGCNTTYCCNCG</strong></p>
<p>Reverse (R2): <strong>​TANACYTCNGGRTGNCCRAARAAYCA</strong></p>
<p>Note the presence of non ATCG bases - these are ambiguities added to the primers to allow them to be less specific and bind to a greater variety of taxa.</p>
<ul>
<li><p>Use the grep command above to search for the primer sequence in a file. If you are unfamilliar with the grep command, see <a class="reference internal" href="fundamentals/grep_command.html#grep-command"><span class="std std-ref">here</span></a>.</p>
<blockquote>
<div><ul class="simple">
<li><p>Note that ambiguities (any base apart from ATCG) should be replaced with a ​. (full stop) which is a special regex symbol meaning “any character”.</p></li>
<li><p>Try writing the command yourself before looking at the answer in the footnote below <a class="footnote-reference brackets" href="#f1" id="id2">1</a>.</p></li>
<li><p>Look at a few different libraries, both forward and reverse, both index and primer.</p></li>
</ul>
</div></blockquote>
</li>
</ul>
<p>You’ll probably see that there are occasions where no index or primer is highlighted on a sequence. This means there was a sequencing error. Look closely and you’ll see that a base is missing or inserted, or just wrong.</p>
<p>We want to split each of these libraries up by index into a separate pair of files for each of the 12 samples, and remove the index sequences. We will do this using the tool cutadapt (<a class="reference external" href="​https://cutadapt.readthedocs.io​">​https://cutadapt.readthedocs.io</a>). This versatile tool allows separating files by index and removal of these indices and primers. It can allow for some error in the index sequence, and can keep read pairs in sync (more on this later).</p>
<p>As ever with a new tool, first cast your eye over the help, either online or buy running:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ cutadapt --help
</pre></div>
</div>
<p>It’s quite long, but at least read the first section. It’s helpful to think about exactly what our data is and what we want to do:</p>
<ul class="simple">
<li><p>We have paired data</p></li>
<li><p>Our indices are at the beginning of the reads</p></li>
<li><p>We have multiple indices (cutadapt calls them ‘adapters’)</p></li>
<li><p>We want to output a different file for each index</p></li>
</ul>
<p>Cutadapt has settings for all of these situations. It will allow reading two files as input, and will ensure that pairs of reads in these files are kept in sync. Indices at the beginning of reads are specified using <code class="docutils literal notranslate"><span class="pre">-g</span></code> ( <code class="docutils literal notranslate"><span class="pre">​-G</span></code> for the second file of reads), and we can specify these multiple times, and give different adapters names. We also specify that the adapters are right at the beginning, with no gaps, using a <code class="docutils literal notranslate"><span class="pre">^</span></code> symbol. We can specify that we want output files depending on the combination of adapters found using the <code class="docutils literal notranslate"><span class="pre">​-o</span></code> and <code class="docutils literal notranslate"><span class="pre">​-p</span></code> options for the first and second files respectively.</p>
<p>Referring to the indices.txt file, we can now construct a command that demultiplexes our Lib1. To avoid a mess of files, I strongly suggest returning up to the parent directory and creating a new directory <a class="footnote-reference brackets" href="#f2" id="id3">2</a> . Call this something appropriate.</p>
<p>This command assumes that you are in the directory containing the “0_rawsequences” directory and an empty directory called “1_demux”. Reminder: using the ​allows us to split the command over multiple lines. You can either type this and press enter afterwards, or you can just ignore it and continue typing the command at the beginning of the next line.</p>
<p>Run the following, then review what is printed to the terminal carefully. Make sure you understand what it’s saying:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ cutadapt -g <span class="nv">T4</span><span class="o">=</span>^AAGAGG -g <span class="nv">T9</span><span class="o">=</span>^AATCGC -g <span class="nv">T11</span><span class="o">=</span>^AGCTAC <span class="se">\</span>
&gt; -G <span class="nv">T4</span><span class="o">=</span>^AAGAGG -G <span class="nv">T9</span><span class="o">=</span>^AATCGC -G <span class="nv">T11</span><span class="o">=</span>^AGCTAC <span class="se">\</span>
&gt; -o 1_demux/<span class="o">{</span>name1<span class="o">}</span>-<span class="o">{</span>name2<span class="o">}</span>_R1.fastq -p 1_demux/<span class="o">{</span>name1<span class="o">}</span>-<span class="o">{</span>name2<span class="o">}</span>_R2.fastq <span class="se">\</span>
&gt; 0_rawsequences/Lib1_R1.fastq 0_rawsequences/Lib1_R2.fastq
</pre></div>
</div>
<ul class="simple">
<li><p>How many files do you expect to get out of this?</p></li>
</ul>
<p>List the files in the demux directory, and run the grep command from the previous section to see the read numbers per file <a class="footnote-reference brackets" href="#f3" id="id4">3</a> . More than you expected?</p>
<p>This is because the command has looked for all adapter combinations. This is nice security against errors. The sequencer has mistakenly associated some reads as the same fragment when they aren’t - they actually come from two different samples, hence some files with two different sample names. And in some cases, no index can be found on one or both of a paired read, probably due to a sequencing error. These are marked as unknown. Happily, all of these errors are in a distinct minority, and the majority of reads have been allocated to files for our samples.</p>
<p>If you add everything up, you’ll notice we’re missing some reads from our original files: these had no mate pair and were completely discarded.</p>
<ul class="simple">
<li><p>Construct three more cutadapt commands to demultiplex the other three libraries, placing the outputs into the same demux directory.</p></li>
</ul>
<p>You should now have lots of files in that demux directory. It’s good practice to keep track of how demultiplexing performed: you could put the output of a grep command into a file to keep a record <a class="footnote-reference brackets" href="#f4" id="id5">4</a>.</p>
<p>Let’s get rid of the files we don’t need. You’ve doubled the amount of storage you’re using - here the files aren’t very large but if you were doing this with a standard dataset, directories would fill up quickly. Navigate to the demux folder, very carefully copy the following command and run it. It works through the files, extracting the first and second sample name, then deletes the file if they don’t match. You do not need to type any ​#comments​, or add the extra spaces - this is just to make it clearer.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="k">for</span> f in *<span class="p">;</span> <span class="k">do</span> <span class="se">\ </span>                         <span class="c1"># loop through files</span>
&gt; <span class="nv">s1</span><span class="o">=</span><span class="si">${</span><span class="nv">f</span><span class="p">%-*</span><span class="si">}</span> <span class="p">;</span> <span class="nv">s2</span><span class="o">=</span><span class="si">${</span><span class="nv">f</span><span class="p">%_*</span><span class="si">}</span> <span class="p">;</span> <span class="nv">s2</span><span class="o">=</span><span class="si">${</span><span class="nv">s2</span><span class="p">#*-</span><span class="si">}</span><span class="p">;</span> <span class="se">\ </span> <span class="c1"># extract sample names</span>
&gt; <span class="k">if</span> <span class="o">[</span> <span class="nv">$s1</span> !<span class="o">=</span> <span class="nv">$s2</span> <span class="o">]</span><span class="p">;</span> <span class="se">\ </span>                     <span class="c1"># check if different</span>
&gt; <span class="k">then</span> rm <span class="nv">$f</span><span class="p">;</span> <span class="se">\ </span>                            <span class="c1"># delete if different</span>
&gt; <span class="k">else</span> mv <span class="nv">$f</span> <span class="si">${</span><span class="nv">f</span><span class="p">#*-</span><span class="si">}</span><span class="p">;</span> <span class="se">\ </span>                    <span class="c1"># keep if same</span>
&gt; <span class="k">fi</span><span class="p">;</span> <span class="se">\ </span>                                    <span class="c1"># end if clause</span>
&gt; <span class="k">done</span>                                      <span class="c1"># end loop</span>
</pre></div>
</div>
<p>An explanation for this code is below. This isn’t a crucial bioinformatics step, it’s just to tidy things up. You don’t need to understand everything about this command, although the loop syntax is going to crop up frequently.</p>
<p>Then also run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ rm unknown*
</pre></div>
</div>
<p>This will delete the files beginning with unknown. These contain the sequences for which no index was identified - we’re not interested in them.</p>
<p>In the above command, the ​for part sets up a loop that works through each file name in the directory, using ​f to store the current name. It then uses something called parameter substitution to strip the names down to the first and second sample names, storing these in two variables. It then asks if the two sample names are different - if so, the current file is deleted, otherwise (i.e. they’re the same), the file is renamed (moved from one name to another), again using parameter substitution to strip out the unneeded parts of the name. You do not need to understand this.</p>
<p>If you’d like to explore more cutadapt parameters check out this extension task: <a class="reference internal" href="extensions/cutadapt_extension.html#cutadapt-extension"><span class="std std-ref">cutadapt extension</span></a>.</p>
<p class="rubric">Footnotes</p>
<dl class="footnote brackets">
<dt class="label" id="f1"><span class="brackets"><a class="fn-backref" href="#id2">1</a></span></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">head</span> <span class="pre">-n</span> <span class="pre">12</span> <span class="pre">​in_R1.fastq​</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">-E</span> <span class="pre">&quot;CC.GA.AT.GC.TT.CC.CG|$&quot;</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">head</span> <span class="pre">-n</span> <span class="pre">12</span> <span class="pre">​in_R2.fastq​</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">-E</span> <span class="pre">&quot;TA.AC.TC.GG.TG.CC.AA.AA.CA|$&quot;</span></code></p>
</dd>
<dt class="label" id="f2"><span class="brackets"><a class="fn-backref" href="#id3">2</a></span></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">cd</span> <span class="pre">../</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">mkdir</span> <span class="pre">1_demux</span></code></p>
</dd>
<dt class="label" id="f3"><span class="brackets"><a class="fn-backref" href="#id4">3</a></span></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">ls</span> <span class="pre">1_demux/*</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">grep</span> <span class="pre">-c</span> <span class="pre">&quot;^&#64;D00&quot;</span> <span class="pre">1_demux/*</span></code></p>
</dd>
<dt class="label" id="f4"><span class="brackets"><a class="fn-backref" href="#id5">4</a></span></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">​grep</span> <span class="pre">-c</span> <span class="pre">&quot;^&#64;D00&quot;</span> <span class="pre">1_demux/*</span> <span class="pre">&gt;</span> <span class="pre">demuxlog.txt</span></code></p>
</dd>
</dl>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="fundamentals/grep_command.html" class="btn btn-neutral float-right" title="Grep command" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="fastq.html" class="btn btn-neutral float-left" title="FASTQ files" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, The Vogler Lab

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>