

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>3. Frequency filtering / denoising &mdash; Analysis of Metagenetic data for Macroecology  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/js/custom.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Extension: Denoising by sample" href="extensions/denoising_by_sample.html" />
    <link rel="prev" title="2. Not Filtering: Dereplication" href="not_filtering_dereplication.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> Analysis of Metagenetic data for Macroecology
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../notes.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linuxintro.html">Command line bioinformatics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../readprocessing.html">Read processing</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../filtering.html">Filtering Amplicon Data</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="quality_filtering.html">1. Quality Filtering</a></li>
<li class="toctree-l2"><a class="reference internal" href="not_filtering_dereplication.html">2. Not Filtering: Dereplication</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">3. Frequency filtering / denoising</a><ul>
<li class="toctree-l3"><a class="reference internal" href="extensions/denoising_by_sample.html">Extension: Denoising by sample</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="indel_filtering.html">4. Indel Filtering</a></li>
<li class="toctree-l2"><a class="reference internal" href="point_error.html">5. Point error filtering</a></li>
<li class="toctree-l2"><a class="reference internal" href="chimera_filtering.html">6. Chimera filtering</a></li>
<li class="toctree-l2"><a class="reference internal" href="metamate.html">Extension: Stringent ASV filtering</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../otudelim.html">OTU Delimitation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../otuid.html">Identifying OTUs and Generating Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trees.html">Building Phylogenetic Trees for Metagenetics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../placing_otus_in_trees.html">Placing OTUs in reference trees</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Analysis of Metagenetic data for Macroecology</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../filtering.html">Filtering Amplicon Data</a> &raquo;</li>
        
      <li>3. Frequency filtering / denoising</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/filtering/freq_filtering_and_denoising.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="frequency-filtering-denoising">
<span id="denoising"></span><h1>3. Frequency filtering / denoising<a class="headerlink" href="#frequency-filtering-denoising" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound">
</div>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Due to the use of PCR to generate metabarcoding datasets, we should generate plenty of copies of the amplicon of interest, and thus many reads - depending on sequencing depth, of course. We can therefore be relatively confident that ASVs that occur at very low frequencies in the dataset are more likely to be errors.</p>
</div>
<div class="section" id="simple-frequency-filtering">
<h2>Simple Frequency Filtering<a class="headerlink" href="#simple-frequency-filtering" title="Permalink to this headline">¶</a></h2>
<p>We can apply a simple threshold, keeping only ASVs that are present at equal to or greater than a given number of reads in the entire dataset. A standard threshold here would be 2, i.e. any singletons will be removed.</p>
<p>We can actually do this as part of the dereplication command we just did. Try running the command from the last section again, with the same input and adding the argument <code class="docutils literal notranslate"><span class="pre">--minuniquesize</span> <span class="pre">2</span></code> ​to get rid of all singleton sequences. <strong>​Use a different output filename​</strong>, we’re not going to keep this output. See the solution below if you get stuck!</p>
<div class="toggle admonition">
<p class="admonition-title">Solution</p>
<p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">vsearch</span> <span class="pre">--derep_fulllength</span> <span class="pre">​in.fasta​</span> <span class="pre">--output</span> <span class="pre">​out.fasta​</span> <span class="pre">--sizeout</span> <span class="pre">--relabel</span> <span class="pre">uniq</span> <span class="pre">--minuniquesize</span> <span class="pre">2</span></code></p>
</div>
<p>This is a straightforward filter, but it doesn’t take into account all of the realities of amplification and sequencing. If an error arose in the later stages of PCR, or occured when sequencing a relatively rare ASV, then it’s reasonable that errors may be infrequent, but if an error arose in the early stages of PCR then it would have been amplified many times.</p>
</div>
<div class="section" id="id1">
<h2>Denoising<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>A much more sophisticated approach to filtering errors is denoising. Denoising algorithms use read frequency and sequence composition to infer likely sequencing errors. ASVs are compared against one another and frequency thresholds are applied relative to counts of similar (but more common) ASVs. Instead of doing the size filtering as part of dereplication, we will instead do it as part of a denoising command. We will use the UNOISE3 algorithm, implemented again in VSEARCH. Your input file here should be the output from dereplicating in the last section.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ vsearch --cluster_unoise ​in.fasta​ --minsize <span class="m">2</span> --unoise_alpha <span class="m">2</span> --centroids out.fasta
</pre></div>
</div>
<p>The key parameter here is the alpha parameter, which determines the threshold level of dissimilarity between frequent and infrequent reads for exclusion of infrequent reads. Note that we’re using a less conservative minsize threshold than the default of 8 because of the smaller size of this toy dataset.</p>
<div class="admonition-exercise admonition">
<p class="admonition-title">Exercise</p>
<p>What is the effect on the number of sequences and size distribution of those sequences of varying the alpha parameter?
You can get the size distribution by running</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ grep -oP <span class="s2">&quot;(?&lt;=size=).*</span>$<span class="s2">&quot;</span> ​in.fasta​ sort <span class="p">|</span> uniq -c
</pre></div>
</div>
<p>In the output of this command, the second column is the count of reads, and the first column is the count of these counts. So for example, if a row says <code class="docutils literal notranslate"><span class="pre">24</span> <span class="pre">12</span></code>, there are 24 ASVs that have 12 reads each.</p>
</div>
</div>
<div class="section" id="selecting-denoising-parameters">
<h2>Selecting Denoising Parameters<a class="headerlink" href="#selecting-denoising-parameters" title="Permalink to this headline">¶</a></h2>
<p>Denoising removed a large proportion of our ASVs, and this might seem like a large amount of data is being thrown away. However, while this removed a lot of unique sequences, the vast majority of them would have been rarer ASVs, and relative to the total number of reads in the dataset relatively few were discarded. Unfortunately, denoising is one of these steps where we cannot choose thresholds and parameter based on an <em>a priori</em> expectation, the settings must be tuned to the dataset and the research questions. As a baseline, it is sensible to always discard singletons. Beyond this, if the dataset is large, the research questions are tolerant to the loss of rare real sequences and/or it is important that as high a proportion of ASVs be valid as possible, then stricter settings (higher <code class="docutils literal notranslate"><span class="pre">--minsize</span></code>, lower <code class="docutils literal notranslate"><span class="pre">--unoise_alpha</span></code>) would be sensible. If the dataset is small and the preservation of as many valid ASVs as possible is preferred despite the probably retention of errors, then less strict settings should be used. The important point is that the decision is justified by the research questions and the dataset is sufficiently sequenced as to be resilient to the suitable settings.</p>
</div>
<div class="section" id="alternative-pipelines-and-software">
<h2>Alternative Pipelines and Software<a class="headerlink" href="#alternative-pipelines-and-software" title="Permalink to this headline">¶</a></h2>
<p>Denoising is crucial to modern metabarcoding pipelines, especially as increased work with Metazoan communities shows the scale of erroneous ASVs present in datasets. This is just one way that denoising can be performed, albeit the most common algorithm used.</p>
<div class="section" id="usearch-vs-vsearch">
<h3>USEARCH vs VSEARCH<a class="headerlink" href="#usearch-vs-vsearch" title="Permalink to this headline">¶</a></h3>
<p>Here we have used the VSEARCH version of the UNOISE algorithm. The USEARCH version may on occasion be more up to date, and also includes chimera filtering (which we will do later). We are using the VSEARCH version because it only does denoising and because it’s completely free and open source, whereas USEARCH is closed source and the free version has memory limitations. Some versions of the USEARCH version also change the output sequence headers in annoying ways that can’t be changed.</p>
<blockquote>
<div><p>We should recognise that Robert Edgar, the author of USEARCH and UNOISE, built this highly useful algorithm, but making software like this fully and freely available to the research community is an important principle and allows not only more rapid software development but greater validation of the algorithms and wider accessibility of these methods.</p>
</div></blockquote>
</div>
<div class="section" id="denoising-by-sample">
<h3>Denoising by Sample<a class="headerlink" href="#denoising-by-sample" title="Permalink to this headline">¶</a></h3>
<p>The standard usage of UNOISE works on the entire dataset, thus considers the frequency of ASVs relative to one another over the entire dataset. However, individual samples within a dataset are rarely evenly sequenced, therefore some ASVs may be rarer because they occur in undersequenced samples, not because they are errors. It may be more appropriate to denoise on the level of individual samples. If you’d like to try this out, you can try out this extension: <cite>Extension: Denoising by Sample &lt;denoise_by_sample&gt;</cite>. Note it may take a little while so you may choose to come back to this later.</p>
</div>
<div class="section" id="other-software">
<h3>Other Software<a class="headerlink" href="#other-software" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://github.com/lh3/bfc">BFC</a> is a fairly common denoiser, often used more in the genomic sequencing realm than in amplicon sequencing, but it is occasionally used in metabarcoding. <a class="reference external" href="https://benjjneb.github.io/dada2/index.html">dada2</a> has recently gained in popularity among metabarcoders. Both of these algorithms work on an earlier stage of the pipeline, on the reads including quality data. In our experience, these algorithms tend to be much more strict than UNOISE3, which may well be appropriate for some questions. We’re not exploring them much here because their approach wraps up many of the steps we’re learning one-by-one, thereby skipping over a lot of the points we try to illustrate in these resources. However, we certainly do not recommend against them; dada2 has an excellent tutorial that in our experience works pretty nicely. We would note that if you try out dada2 for a coding region such as COX1, length and translation filtering should be performed on the denoised outputs.</p>
</div>
</div>
<div class="section" id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Permalink to this headline">¶</a></h2>
<p>You should have produced many denoised outputs while you were playing around with the thresholds. We suggest you clean these up and proceed using the output from the command given above, i.e. with <code class="docutils literal notranslate"><span class="pre">--minsize</span> <span class="pre">2</span> <span class="pre">--unoise_alpha</span> <span class="pre">2</span></code>. This file contains a more filtered set of ASVs than we started with, but there are still other sources of error we can address, starting with <cite>4. Indel Filtering &lt;indel_filtering&gt;</cite>.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="extensions/denoising_by_sample.html" class="btn btn-neutral float-right" title="Extension: Denoising by sample" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="not_filtering_dereplication.html" class="btn btn-neutral float-left" title="2. Not Filtering: Dereplication" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, The Vogler Lab

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>